{"version":3,"sources":["../../../../src/build/analyze/index.ts"],"sourcesContent":["import type { NextConfigComplete } from '../../server/config-shared'\nimport type { __ApiPreviewProps } from '../../server/api-utils'\n\nimport { setGlobal } from '../../trace'\nimport * as Log from '../output/log'\nimport * as path from 'node:path'\nimport loadConfig from '../../server/config'\nimport { PHASE_ANALYZE } from '../../shared/lib/constants'\nimport { turbopackAnalyze, type AnalyzeContext } from '../turbopack-analyze'\nimport { durationToString } from '../duration-to-string'\nimport { cp, writeFile, mkdir } from 'node:fs/promises'\nimport {\n  collectAppFiles,\n  collectPagesFiles,\n  createPagesMapping,\n} from '../entries'\nimport { createValidFileMatcher } from '../../server/lib/find-page-file'\nimport { findPagesDir } from '../../lib/find-pages-dir'\nimport { PAGE_TYPES } from '../../lib/page-types'\nimport loadCustomRoutes from '../../lib/load-custom-routes'\nimport { generateRoutesManifest } from '../generate-routes-manifest'\nimport { checkIsAppPPREnabled } from '../../server/lib/experimental/ppr'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport http from 'node:http'\n\n// @ts-expect-error types are in @types/serve-handler\nimport serveHandler from 'next/dist/compiled/serve-handler'\nimport { Telemetry } from '../../telemetry/storage'\nimport { eventAnalyzeCompleted } from '../../telemetry/events'\nimport { traceGlobals } from '../../trace/shared'\nimport type { RoutesManifest } from '..'\n\nconst ANALYZE_PATH = '.next/diagnostics/analyze'\n\nexport type AnalyzeOptions = {\n  dir: string\n  reactProductionProfiling?: boolean\n  noMangling?: boolean\n  appDirOnly?: boolean\n  serve?: boolean\n  port?: number\n}\n\nexport default async function analyze({\n  dir,\n  reactProductionProfiling = false,\n  noMangling = false,\n  appDirOnly = false,\n  serve = false,\n  port = 4000,\n}: AnalyzeOptions): Promise<void> {\n  try {\n    const config: NextConfigComplete = await loadConfig(PHASE_ANALYZE, dir, {\n      silent: false,\n      reactProductionProfiling,\n    })\n\n    process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n\n    const distDir = path.join(dir, '.next')\n    const telemetry = new Telemetry({ distDir })\n    setGlobal('phase', PHASE_ANALYZE)\n    setGlobal('distDir', distDir)\n    setGlobal('telemetry', telemetry)\n\n    Log.info('Analyzing a production build...')\n\n    const analyzeContext: AnalyzeContext = {\n      config,\n      dir,\n      distDir,\n      noMangling,\n      appDirOnly,\n    }\n\n    const { duration: analyzeDuration, shutdownPromise } =\n      await turbopackAnalyze(analyzeContext)\n\n    const durationString = durationToString(analyzeDuration)\n    let logMessage = `Analyze completed in ${durationString}.`\n    if (!serve) {\n      logMessage += ` To explore the analyze results, run \\`next experimental-analyze --serve\\`.`\n    }\n    Log.event(logMessage)\n\n    await shutdownPromise\n\n    await cp(\n      path.join(__dirname, '../../bundle-analyzer'),\n      path.join(dir, ANALYZE_PATH),\n      { recursive: true }\n    )\n\n    // Collect and write routes for the bundle analyzer\n    const routes = await collectRoutesForAnalyze(dir, config, appDirOnly)\n\n    await mkdir(path.join(dir, ANALYZE_PATH, 'data'), { recursive: true })\n    await writeFile(\n      path.join(dir, ANALYZE_PATH, 'data', 'routes.json'),\n      JSON.stringify(routes, null, 2)\n    )\n\n    telemetry.record(\n      eventAnalyzeCompleted({\n        success: true,\n        durationInSeconds: Math.round(analyzeDuration),\n        totalPageCount: routes.length,\n      })\n    )\n\n    if (serve) {\n      await startServer(path.join(dir, ANALYZE_PATH), port)\n    }\n  } catch (e) {\n    const telemetry = traceGlobals.get('telemetry') as Telemetry | undefined\n    if (telemetry) {\n      telemetry.record(\n        eventAnalyzeCompleted({\n          success: false,\n        })\n      )\n    }\n\n    throw e\n  }\n}\n\n/**\n * Collects all routes from the project for the bundle analyzer.\n * Returns a list of route paths (both static and dynamic).\n */\nasync function collectRoutesForAnalyze(\n  dir: string,\n  config: NextConfigComplete,\n  appDirOnly: boolean\n): Promise<string[]> {\n  const { pagesDir, appDir } = findPagesDir(dir)\n  const validFileMatcher = createValidFileMatcher(config.pageExtensions, appDir)\n\n  let appType: RoutesManifest['appType']\n  if (pagesDir && appDir) {\n    appType = 'hybrid'\n  } else if (pagesDir) {\n    appType = 'pages'\n  } else if (appDir) {\n    appType = 'app'\n  } else {\n    throw new Error('No pages or app directory found.')\n  }\n\n  const { appPaths } = appDir\n    ? await collectAppFiles(appDir, validFileMatcher)\n    : { appPaths: [] }\n  const pagesPaths = pagesDir\n    ? await collectPagesFiles(pagesDir, validFileMatcher)\n    : null\n\n  const appMapping = await createPagesMapping({\n    pagePaths: appPaths,\n    isDev: false,\n    pagesType: PAGE_TYPES.APP,\n    pageExtensions: config.pageExtensions,\n    pagesDir,\n    appDir,\n    appDirOnly,\n  })\n\n  const pagesMapping = pagesPaths\n    ? await createPagesMapping({\n        pagePaths: pagesPaths,\n        isDev: false,\n        pagesType: PAGE_TYPES.PAGES,\n        pageExtensions: config.pageExtensions,\n        pagesDir,\n        appDir,\n        appDirOnly,\n      })\n    : null\n\n  const pageKeys = {\n    pages: pagesMapping ? Object.keys(pagesMapping) : [],\n    app: appMapping\n      ? Object.keys(appMapping).map((key) => normalizeAppPath(key))\n      : undefined,\n  }\n\n  // Load custom routes\n  const { redirects, headers, rewrites } = await loadCustomRoutes(config)\n\n  // Compute restricted redirect paths\n  const restrictedRedirectPaths = ['/_next'].map((pathPrefix) =>\n    config.basePath ? `${config.basePath}${pathPrefix}` : pathPrefix\n  )\n\n  const isAppPPREnabled = checkIsAppPPREnabled(config.experimental.ppr)\n\n  // Generate routes manifest\n  const { routesManifest } = generateRoutesManifest({\n    appType,\n    pageKeys,\n    config,\n    redirects,\n    headers,\n    rewrites,\n    restrictedRedirectPaths,\n    isAppPPREnabled,\n  })\n\n  return routesManifest.dynamicRoutes\n    .map((r) => r.page)\n    .concat(routesManifest.staticRoutes.map((r) => r.page))\n}\n\nfunction startServer(dir: string, port: number): Promise<void> {\n  const server = http.createServer((req, res) => {\n    return serveHandler(req, res, {\n      public: dir,\n    })\n  })\n\n  return new Promise((resolve, reject) => {\n    function onError(err: Error) {\n      server.close(() => {\n        reject(err)\n      })\n    }\n\n    server.on('error', onError)\n\n    server.listen(port, 'localhost', () => {\n      const address = server.address()\n      if (address == null) {\n        reject(new Error('Unable to get server address'))\n        return\n      }\n\n      // No longer needed after startup\n      server.removeListener('error', onError)\n\n      let addressString\n      if (typeof address === 'string') {\n        addressString = address\n      } else if (\n        address.family === 'IPv6' &&\n        (address.address === '::' || address.address === '::1')\n      ) {\n        addressString = `localhost:${address.port}`\n      } else if (address.family === 'IPv6') {\n        addressString = `[${address.address}]:${address.port}`\n      } else {\n        addressString = `${address.address}:${address.port}`\n      }\n\n      Log.info(`Bundle analyzer available at http://${addressString}`)\n      resolve()\n    })\n  })\n}\n"],"names":["setGlobal","Log","path","loadConfig","PHASE_ANALYZE","turbopackAnalyze","durationToString","cp","writeFile","mkdir","collectAppFiles","collectPagesFiles","createPagesMapping","createValidFileMatcher","findPagesDir","PAGE_TYPES","loadCustomRoutes","generateRoutesManifest","checkIsAppPPREnabled","normalizeAppPath","http","serveHandler","Telemetry","eventAnalyzeCompleted","traceGlobals","ANALYZE_PATH","analyze","dir","reactProductionProfiling","noMangling","appDirOnly","serve","port","config","silent","process","env","NEXT_DEPLOYMENT_ID","deploymentId","distDir","join","telemetry","info","analyzeContext","duration","analyzeDuration","shutdownPromise","durationString","logMessage","event","__dirname","recursive","routes","collectRoutesForAnalyze","JSON","stringify","record","success","durationInSeconds","Math","round","totalPageCount","length","startServer","e","get","pagesDir","appDir","validFileMatcher","pageExtensions","appType","Error","appPaths","pagesPaths","appMapping","pagePaths","isDev","pagesType","APP","pagesMapping","PAGES","pageKeys","pages","Object","keys","app","map","key","undefined","redirects","headers","rewrites","restrictedRedirectPaths","pathPrefix","basePath","isAppPPREnabled","experimental","ppr","routesManifest","dynamicRoutes","r","page","concat","staticRoutes","server","createServer","req","res","public","Promise","resolve","reject","onError","err","close","on","listen","address","removeListener","addressString","family"],"mappings":"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","ignoreList":[0]}