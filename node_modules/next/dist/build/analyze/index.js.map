{"version":3,"sources":["../../../src/build/analyze/index.ts"],"sourcesContent":["import type { NextConfigComplete } from '../../server/config-shared'\nimport type { __ApiPreviewProps } from '../../server/api-utils'\n\nimport { setGlobal } from '../../trace'\nimport * as Log from '../output/log'\nimport * as path from 'node:path'\nimport loadConfig from '../../server/config'\nimport { PHASE_ANALYZE } from '../../shared/lib/constants'\nimport { turbopackAnalyze, type AnalyzeContext } from '../turbopack-analyze'\nimport { durationToString } from '../duration-to-string'\nimport { cp, writeFile, mkdir } from 'node:fs/promises'\nimport {\n  collectAppFiles,\n  collectPagesFiles,\n  createPagesMapping,\n} from '../entries'\nimport { createValidFileMatcher } from '../../server/lib/find-page-file'\nimport { findPagesDir } from '../../lib/find-pages-dir'\nimport { PAGE_TYPES } from '../../lib/page-types'\nimport loadCustomRoutes from '../../lib/load-custom-routes'\nimport { generateRoutesManifest } from '../generate-routes-manifest'\nimport { checkIsAppPPREnabled } from '../../server/lib/experimental/ppr'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport http from 'node:http'\n\n// @ts-expect-error types are in @types/serve-handler\nimport serveHandler from 'next/dist/compiled/serve-handler'\nimport { Telemetry } from '../../telemetry/storage'\nimport { eventAnalyzeCompleted } from '../../telemetry/events'\nimport { traceGlobals } from '../../trace/shared'\nimport type { RoutesManifest } from '..'\n\nconst ANALYZE_PATH = '.next/diagnostics/analyze'\n\nexport type AnalyzeOptions = {\n  dir: string\n  reactProductionProfiling?: boolean\n  noMangling?: boolean\n  appDirOnly?: boolean\n  serve?: boolean\n  port?: number\n}\n\nexport default async function analyze({\n  dir,\n  reactProductionProfiling = false,\n  noMangling = false,\n  appDirOnly = false,\n  serve = false,\n  port = 4000,\n}: AnalyzeOptions): Promise<void> {\n  try {\n    const config: NextConfigComplete = await loadConfig(PHASE_ANALYZE, dir, {\n      silent: false,\n      reactProductionProfiling,\n    })\n\n    process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n\n    const distDir = path.join(dir, '.next')\n    const telemetry = new Telemetry({ distDir })\n    setGlobal('phase', PHASE_ANALYZE)\n    setGlobal('distDir', distDir)\n    setGlobal('telemetry', telemetry)\n\n    Log.info('Analyzing a production build...')\n\n    const analyzeContext: AnalyzeContext = {\n      config,\n      dir,\n      distDir,\n      noMangling,\n      appDirOnly,\n    }\n\n    const { duration: analyzeDuration, shutdownPromise } =\n      await turbopackAnalyze(analyzeContext)\n\n    const durationString = durationToString(analyzeDuration)\n    let logMessage = `Analyze completed in ${durationString}.`\n    if (!serve) {\n      logMessage += ` To explore the analyze results, run \\`next experimental-analyze --serve\\`.`\n    }\n    Log.event(logMessage)\n\n    await shutdownPromise\n\n    await cp(\n      path.join(__dirname, '../../bundle-analyzer'),\n      path.join(dir, ANALYZE_PATH),\n      { recursive: true }\n    )\n\n    // Collect and write routes for the bundle analyzer\n    const routes = await collectRoutesForAnalyze(dir, config, appDirOnly)\n\n    await mkdir(path.join(dir, ANALYZE_PATH, 'data'), { recursive: true })\n    await writeFile(\n      path.join(dir, ANALYZE_PATH, 'data', 'routes.json'),\n      JSON.stringify(routes, null, 2)\n    )\n\n    telemetry.record(\n      eventAnalyzeCompleted({\n        success: true,\n        durationInSeconds: Math.round(analyzeDuration),\n        totalPageCount: routes.length,\n      })\n    )\n\n    if (serve) {\n      await startServer(path.join(dir, ANALYZE_PATH), port)\n    }\n  } catch (e) {\n    const telemetry = traceGlobals.get('telemetry') as Telemetry | undefined\n    if (telemetry) {\n      telemetry.record(\n        eventAnalyzeCompleted({\n          success: false,\n        })\n      )\n    }\n\n    throw e\n  }\n}\n\n/**\n * Collects all routes from the project for the bundle analyzer.\n * Returns a list of route paths (both static and dynamic).\n */\nasync function collectRoutesForAnalyze(\n  dir: string,\n  config: NextConfigComplete,\n  appDirOnly: boolean\n): Promise<string[]> {\n  const { pagesDir, appDir } = findPagesDir(dir)\n  const validFileMatcher = createValidFileMatcher(config.pageExtensions, appDir)\n\n  let appType: RoutesManifest['appType']\n  if (pagesDir && appDir) {\n    appType = 'hybrid'\n  } else if (pagesDir) {\n    appType = 'pages'\n  } else if (appDir) {\n    appType = 'app'\n  } else {\n    throw new Error('No pages or app directory found.')\n  }\n\n  const { appPaths } = appDir\n    ? await collectAppFiles(appDir, validFileMatcher)\n    : { appPaths: [] }\n  const pagesPaths = pagesDir\n    ? await collectPagesFiles(pagesDir, validFileMatcher)\n    : null\n\n  const appMapping = await createPagesMapping({\n    pagePaths: appPaths,\n    isDev: false,\n    pagesType: PAGE_TYPES.APP,\n    pageExtensions: config.pageExtensions,\n    pagesDir,\n    appDir,\n    appDirOnly,\n  })\n\n  const pagesMapping = pagesPaths\n    ? await createPagesMapping({\n        pagePaths: pagesPaths,\n        isDev: false,\n        pagesType: PAGE_TYPES.PAGES,\n        pageExtensions: config.pageExtensions,\n        pagesDir,\n        appDir,\n        appDirOnly,\n      })\n    : null\n\n  const pageKeys = {\n    pages: pagesMapping ? Object.keys(pagesMapping) : [],\n    app: appMapping\n      ? Object.keys(appMapping).map((key) => normalizeAppPath(key))\n      : undefined,\n  }\n\n  // Load custom routes\n  const { redirects, headers, rewrites } = await loadCustomRoutes(config)\n\n  // Compute restricted redirect paths\n  const restrictedRedirectPaths = ['/_next'].map((pathPrefix) =>\n    config.basePath ? `${config.basePath}${pathPrefix}` : pathPrefix\n  )\n\n  const isAppPPREnabled = checkIsAppPPREnabled(config.experimental.ppr)\n\n  // Generate routes manifest\n  const { routesManifest } = generateRoutesManifest({\n    appType,\n    pageKeys,\n    config,\n    redirects,\n    headers,\n    rewrites,\n    restrictedRedirectPaths,\n    isAppPPREnabled,\n  })\n\n  return routesManifest.dynamicRoutes\n    .map((r) => r.page)\n    .concat(routesManifest.staticRoutes.map((r) => r.page))\n}\n\nfunction startServer(dir: string, port: number): Promise<void> {\n  const server = http.createServer((req, res) => {\n    return serveHandler(req, res, {\n      public: dir,\n    })\n  })\n\n  return new Promise((resolve, reject) => {\n    function onError(err: Error) {\n      server.close(() => {\n        reject(err)\n      })\n    }\n\n    server.on('error', onError)\n\n    server.listen(port, 'localhost', () => {\n      const address = server.address()\n      if (address == null) {\n        reject(new Error('Unable to get server address'))\n        return\n      }\n\n      // No longer needed after startup\n      server.removeListener('error', onError)\n\n      let addressString\n      if (typeof address === 'string') {\n        addressString = address\n      } else if (\n        address.family === 'IPv6' &&\n        (address.address === '::' || address.address === '::1')\n      ) {\n        addressString = `localhost:${address.port}`\n      } else if (address.family === 'IPv6') {\n        addressString = `[${address.address}]:${address.port}`\n      } else {\n        addressString = `${address.address}:${address.port}`\n      }\n\n      Log.info(`Bundle analyzer available at http://${addressString}`)\n      resolve()\n    })\n  })\n}\n"],"names":["analyze","ANALYZE_PATH","dir","reactProductionProfiling","noMangling","appDirOnly","serve","port","config","loadConfig","PHASE_ANALYZE","silent","process","env","NEXT_DEPLOYMENT_ID","deploymentId","distDir","path","join","telemetry","Telemetry","setGlobal","Log","info","analyzeContext","duration","analyzeDuration","shutdownPromise","turbopackAnalyze","durationString","durationToString","logMessage","event","cp","__dirname","recursive","routes","collectRoutesForAnalyze","mkdir","writeFile","JSON","stringify","record","eventAnalyzeCompleted","success","durationInSeconds","Math","round","totalPageCount","length","startServer","e","traceGlobals","get","pagesDir","appDir","findPagesDir","validFileMatcher","createValidFileMatcher","pageExtensions","appType","Error","appPaths","collectAppFiles","pagesPaths","collectPagesFiles","appMapping","createPagesMapping","pagePaths","isDev","pagesType","PAGE_TYPES","APP","pagesMapping","PAGES","pageKeys","pages","Object","keys","app","map","key","normalizeAppPath","undefined","redirects","headers","rewrites","loadCustomRoutes","restrictedRedirectPaths","pathPrefix","basePath","isAppPPREnabled","checkIsAppPPREnabled","experimental","ppr","routesManifest","generateRoutesManifest","dynamicRoutes","r","page","concat","staticRoutes","server","http","createServer","req","res","serveHandler","public","Promise","resolve","reject","onError","err","close","on","listen","address","removeListener","addressString","family"],"mappings":"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","ignoreList":[0]}