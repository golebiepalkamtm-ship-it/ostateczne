services:
  # PostgreSQL Database (Production)
  postgres:
    image: postgres:16-alpine
    container_name: palkamtm-postgres-prod
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-palkamtm_production}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching (Production)
  redis:
    image: redis:7.4-alpine
    container_name: palkamtm-redis-prod
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_prod_data:/data
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3

  # Prisma Migrations & Client Generation (Production)
  prisma:
    image: node:20-alpine
    container_name: palkamtm-prisma-prod
    restart: 'no'
    working_dir: /app
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-palkamtm_production}
      # Next.js telemetry
      NEXT_TELEMETRY_DISABLED: 1
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - app-network
    entrypoint: sh
    command: >
      -c "
        echo 'ðŸ“¦ Installing dependencies...' &&
        npm ci --silent --legacy-peer-deps &&
        echo 'ðŸ”„ Generating Prisma Client...' &&
        npx prisma generate &&
        echo 'ðŸš€ Running database migrations...' &&
        npx prisma migrate deploy &&
        echo 'âœ… Prisma setup completed!'
      "

  # Next.js Application (Production)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: palkamtm-app-prod
    restart: always
    ports:
      - "3001:3000"
    volumes:
      - ./public/uploads:/app/public/uploads
      - ./public/models:/app/public/models
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-palkamtm_production}
      
      # Redis
      REDIS_URL: redis://default:${REDIS_PASSWORD}@redis:6379
      
      # Next.js
      NODE_ENV: production
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      
      # NextAuth
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://palkamtm.pl}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      
      # Firebase (Client)
      NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${NEXT_PUBLIC_FIREBASE_APP_ID}
      
      # Firebase (Admin)
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL}
      FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY}
      FIREBASE_AUTH_URI: ${FIREBASE_AUTH_URI:-https://accounts.google.com/o/oauth2/auth}
      FIREBASE_TOKEN_URI: ${FIREBASE_TOKEN_URI:-https://oauth2.googleapis.com/token}
      
      # Email
      EMAIL_SERVER_HOST: ${EMAIL_SERVER_HOST}
      EMAIL_SERVER_PORT: ${EMAIL_SERVER_PORT:-587}
      EMAIL_SERVER_USER: ${EMAIL_SERVER_USER}
      EMAIL_SERVER_PASSWORD: ${EMAIL_SERVER_PASSWORD}
      EMAIL_FROM: ${EMAIL_FROM}
      CONTACT_EMAIL: ${CONTACT_EMAIL}
      
      # SMS
      SMS_PROVIDER: ${SMS_PROVIDER:-firebase}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
      
      # Disable telemetry
      NEXT_TELEMETRY_DISABLED: 1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      prisma:
        condition: service_completed_successfully

  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: palkamtm-prometheus-prod
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - app-network

  grafana:
    image: grafana/grafana:11.5.0
    container_name: palkamtm-grafana-prod
    restart: always
    ports:
      - "4000:3000"
    environment:
      GRAFANA_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GRAFANA_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin123}
    volumes:
      - grafana_prod_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - app-network

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local
  grafana_prod_data:
    driver: local

networks:
  app-network:
    driver: bridge

